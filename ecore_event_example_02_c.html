<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <title>ecore events and handlers - Setup and use</title>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-110876574-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-110876574-1');
  </script>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link rel="icon" href="favicon.png" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
  <link rel="icon" href="favicon.png" type="image/ico">
  <link rel="shortcut icon" href="favicon.png" type="image/ico">
  <link rel="stylesheet" type="text/css" href="e.css">
</head>
<body>
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ecore events and handlers - Setup and use </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This example shows how to create a new type of event, setup some event handlers to it, fire the event and have the callbacks called.</p>
<p>After finishing, we delete the event handlers so no memory will leak.</p>
<p>See the full source code for this example <a class="el" href="ecore_event_example_02_8c-example.html">here</a>.</p>
<p>Let's start the example from the beginning:</p>
 <div class="fragment"><div class="line"><span class="comment">//Compile with:</span></div>
<div class="line"><span class="comment">// gcc -g -Wall -o ecore_event_example_02 ecore_event_example_02.c `pkg-config --cflags --libs ecore`</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;Ecore.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>context   <span class="comment">// helper struct to give some context to the callbacks</span></div>
<div class="line">{</div>
<div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span>          *str1, *str2;</div>
<div class="line">   <a class="code" href="group__Ecore__Event__Group.html#ga252a2566c9c7c9094964ab8e157f0521">Ecore_Event_Handler</a> *handler1;</div>
<div class="line">   <a class="code" href="group__Ecore__Event__Group.html#ga252a2566c9c7c9094964ab8e157f0521">Ecore_Event_Handler</a> *handler2;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> _event_type = 0; <span class="comment">// a new type of event will be defined and stored here</span></div>
<div class="ttc" id="agroup__Ecore__Event__Group_html_ga252a2566c9c7c9094964ab8e157f0521"><div class="ttname"><a href="group__Ecore__Event__Group.html#ga252a2566c9c7c9094964ab8e157f0521">Ecore_Event_Handler</a></div><div class="ttdeci">struct _Ecore_Event_Handler Ecore_Event_Handler</div><div class="ttdoc">A handle for an event handler.</div><div class="ttdef"><b>Definition:</b> Ecore_Common.h:576</div></div>
</div><!-- fragment --><p> First thing is to declare a struct that will be passed as context to the event handlers. In this structure we will store the event handler pointers, and two strings that will be used by the first event handler. We also will use a global integer to store the event type used for our event. It is initialized with 0 in the beginning because the event wasn't created yet. Later, in the main function we will use <a class="el" href="group__Ecore__Event__Group.html#ga3fad8d8bfe3776c69d33aff1f056ba89" title="Allocates a new event type id sensibly and returns the new id.">ecore_event_type_new()</a> to associate another value to it. Now the event handler callbacks:</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__Eina__Types__Group.html#ga3fe0caf72e93b1bab1ca8ee3ccf3f226">Eina_Bool</a></div>
<div class="line">_event_handler1_cb(<span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> type <a class="code" href="group__Eina__Types__Group.html#ga82d751be730f849719ca292f9558be87">EINA_UNUSED</a>, <span class="keywordtype">void</span> *event)</div>
<div class="line">{</div>
<div class="line">   <span class="keywordtype">int</span> *number = event;</div>
<div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *str = data;</div>
<div class="line"> </div>
<div class="line">   printf(<span class="stringliteral">&quot;event_handler1: number=%d, data=\&quot;%s\&quot;.\n&quot;</span>, *number, str);</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">if</span> ((*number % 2) == 0)</div>
<div class="line">     <span class="keywordflow">return</span> <a class="code" href="group__Ecore__Main__Loop__Group.html#ga780091d7d49a4bb6cb753f12e1a3b19d">ECORE_CALLBACK_DONE</a>;</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">return</span> <a class="code" href="group__Ecore__Main__Loop__Group.html#ga6a2922b8aa10c60f27c8ab49d84d75f2">ECORE_CALLBACK_PASS_ON</a>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__Ecore__Main__Loop__Group_html_ga6a2922b8aa10c60f27c8ab49d84d75f2"><div class="ttname"><a href="group__Ecore__Main__Loop__Group.html#ga6a2922b8aa10c60f27c8ab49d84d75f2">ECORE_CALLBACK_PASS_ON</a></div><div class="ttdeci">#define ECORE_CALLBACK_PASS_ON</div><div class="ttdoc">Return value to pass event to next handler.</div><div class="ttdef"><b>Definition:</b> Ecore_Common.h:155</div></div>
<div class="ttc" id="agroup__Ecore__Main__Loop__Group_html_ga780091d7d49a4bb6cb753f12e1a3b19d"><div class="ttname"><a href="group__Ecore__Main__Loop__Group.html#ga780091d7d49a4bb6cb753f12e1a3b19d">ECORE_CALLBACK_DONE</a></div><div class="ttdeci">#define ECORE_CALLBACK_DONE</div><div class="ttdoc">Return value to stop event handling.</div><div class="ttdef"><b>Definition:</b> Ecore_Common.h:156</div></div>
<div class="ttc" id="agroup__Eina__Types__Group_html_ga3fe0caf72e93b1bab1ca8ee3ccf3f226"><div class="ttname"><a href="group__Eina__Types__Group.html#ga3fe0caf72e93b1bab1ca8ee3ccf3f226">Eina_Bool</a></div><div class="ttdeci">unsigned char Eina_Bool</div><div class="ttdoc">Type to mimic a boolean.</div><div class="ttdef"><b>Definition:</b> eina_types.h:527</div></div>
<div class="ttc" id="agroup__Eina__Types__Group_html_ga82d751be730f849719ca292f9558be87"><div class="ttname"><a href="group__Eina__Types__Group.html#ga82d751be730f849719ca292f9558be87">EINA_UNUSED</a></div><div class="ttdeci">#define EINA_UNUSED</div><div class="ttdoc">Used to indicate that a function parameter is purposely unused.</div><div class="ttdef"><b>Definition:</b> eina_types.h:339</div></div>
</div><!-- fragment --><p> This is the first event handler callback. It prints the event data received by the event, and the data passed to this handler when it was added. Notice that this callback already knows that the event data is an integer pointer, and that the handler data is a string. It knows about the first one because this is based on the type of event that is going to be handled, and the second because it was passed to the <a class="el" href="group__Ecore__Event__Group.html#gae75b0b1b2c50e73b8e42afc628b00a62" title="Adds an event handler.">ecore_event_handler_add()</a> function when registering the event handler.</p>
<p>Another interesting point about this callback is that it returns <a class="el" href="group__Ecore__Main__Loop__Group.html#ga780091d7d49a4bb6cb753f12e1a3b19d">ECORE_CALLBACK_DONE</a> (0) if the event data is even, swallowing the event and don't allowing any other callback to be called after this one for this event. Otherwise it returns <a class="el" href="group__Ecore__Main__Loop__Group.html#ga6a2922b8aa10c60f27c8ab49d84d75f2">ECORE_CALLBACK_PASS_ON</a>, allowing the event to be handled by other event handlers registered for this event. This makes the second event handler be called just for "odd" events.</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__Eina__Types__Group.html#ga3fe0caf72e93b1bab1ca8ee3ccf3f226">Eina_Bool</a></div>
<div class="line">_event_handler2_cb(<span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> type <a class="code" href="group__Eina__Types__Group.html#ga82d751be730f849719ca292f9558be87">EINA_UNUSED</a>, <span class="keywordtype">void</span> *event) <span class="comment">// event callback</span></div>
<div class="line">{</div>
<div class="line">   <span class="keyword">struct </span>context *ctxt = data;</div>
<div class="line">   <span class="keywordtype">int</span> *number = event;</div>
<div class="line"> </div>
<div class="line">   printf(<span class="stringliteral">&quot;event_handler2: number=%d.\n&quot;</span>, *number);</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">if</span> (*number == 5)</div>
<div class="line">     {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *old = NULL;</div>
<div class="line">        old = <a class="code" href="group__Ecore__Event__Group.html#ga3ea928587c004f09a6d1b1bd7948327a">ecore_event_handler_data_set</a>(ctxt-&gt;handler1, (<span class="keywordtype">void</span> *)ctxt-&gt;str2);</div>
<div class="line">        printf(<span class="stringliteral">&quot;changed handler1 data from \&quot;%s\&quot; to \&quot;%s\&quot;.\n&quot;</span>,</div>
<div class="line">               old, ctxt-&gt;str2);</div>
<div class="line">     }</div>
<div class="line">   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*number &gt;= 10)</div>
<div class="line">     {</div>
<div class="line">        printf(<span class="stringliteral">&quot;finish main loop.\n&quot;</span>);</div>
<div class="line">        <a class="code" href="group__Ecore__Main__Loop__Group.html#ga95cf8e97dff0716433c2c5474d606a98">ecore_main_loop_quit</a>();</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">return</span> <a class="code" href="group__Ecore__Main__Loop__Group.html#ga780091d7d49a4bb6cb753f12e1a3b19d">ECORE_CALLBACK_DONE</a>; <span class="comment">// same as EINA_FALSE</span></div>
<div class="ttc" id="agroup__Ecore__Event__Group_html_ga3ea928587c004f09a6d1b1bd7948327a"><div class="ttname"><a href="group__Ecore__Event__Group.html#ga3ea928587c004f09a6d1b1bd7948327a">ecore_event_handler_data_set</a></div><div class="ttdeci">void * ecore_event_handler_data_set(Ecore_Event_Handler *eh, const void *data)</div><div class="ttdoc">Sets the data associated with an Ecore_Event_Handler.</div><div class="ttdef"><b>Definition:</b> ecore_events.c:44</div></div>
<div class="ttc" id="agroup__Ecore__Main__Loop__Group_html_ga95cf8e97dff0716433c2c5474d606a98"><div class="ttname"><a href="group__Ecore__Main__Loop__Group.html#ga95cf8e97dff0716433c2c5474d606a98">ecore_main_loop_quit</a></div><div class="ttdeci">void ecore_main_loop_quit(void)</div><div class="ttdoc">Quits the main loop once all the events currently on the queue have been processed.</div><div class="ttdef"><b>Definition:</b> ecore_main.c:1321</div></div>
<div class="line">}</div>
</div><!-- fragment --><p> The second event handler will check if the event data is equal to 5, and if that's the case, it will change the event handler data of the first event handler to another string. Then it checks if the event data is higher than 10, and if so, it will request the main loop to quit.</p>
<p>An interesting point of this example is that although the second event handler requests the main loop to finish after the 11th event being received, it will process all the events that were already fired, and call their respective event handlers, before the main loop stops. If we didn't want these event handlers to be called after the 11th event, we would need to unregister them with <a class="el" href="group__Ecore__Event__Group.html#ga5eb9f359e0c52a63767c235d2f413197" title="Deletes an event handler.">ecore_event_handler_del()</a> at this point.</p>
<p>Now some basic initialization of the context, and the Ecore library itself:</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">struct </span>context ctxt = {0};</div>
<div class="line">   <span class="keywordtype">int</span> i;</div>
<div class="line">   ctxt.str1 = <span class="stringliteral">&quot;dataone&quot;</span>;</div>
<div class="line">   ctxt.str2 = <span class="stringliteral">&quot;datatwo&quot;</span>;</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">if</span> (!<a class="code" href="group__Ecore__Init__Group.html#ga77757609684a2c922dc5ec398274751b">ecore_init</a>())</div>
<div class="line">     {</div>
<div class="line">        printf(<span class="stringliteral">&quot;ERROR: Cannot init Ecore!\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">   _event_type = <a class="code" href="group__Ecore__Event__Group.html#ga3fad8d8bfe3776c69d33aff1f056ba89">ecore_event_type_new</a>();</div>
<div class="ttc" id="agroup__Ecore__Event__Group_html_ga3fad8d8bfe3776c69d33aff1f056ba89"><div class="ttname"><a href="group__Ecore__Event__Group.html#ga3fad8d8bfe3776c69d33aff1f056ba89">ecore_event_type_new</a></div><div class="ttdeci">int ecore_event_type_new(void)</div><div class="ttdoc">Allocates a new event type id sensibly and returns the new id.</div><div class="ttdef"><b>Definition:</b> ecore_events.c:80</div></div>
<div class="ttc" id="agroup__Ecore__Init__Group_html_ga77757609684a2c922dc5ec398274751b"><div class="ttname"><a href="group__Ecore__Init__Group.html#ga77757609684a2c922dc5ec398274751b">ecore_init</a></div><div class="ttdeci">EAPI int ecore_init(void)</div><div class="ttdoc">Sets up connections, signal handlers, sockets etc.</div><div class="ttdef"><b>Definition:</b> ecore.c:230</div></div>
</div><!-- fragment --><p> This last line is interesting. It creates a new type of event and returns a unique ID for this event inside Ecore. This ID can be used anywhere else in your program to reference this specific type of event, and to add callbacks to it.</p>
<p>It's common if you are implementing a library that declares new types of events to export their respective types as extern in the header files. This way, when the library is initialized and the new type is created, it will be available through the header file to an application using it add some callbacks to it. Since our example is self-contained, we are just putting it as a global variable.</p>
<p>Now we add some callbacks:</p>
<div class="fragment"><div class="line"> </div>
<div class="line">   ctxt.handler1 = <a class="code" href="group__Ecore__Event__Group.html#gae75b0b1b2c50e73b8e42afc628b00a62">ecore_event_handler_add</a>(_event_type,</div>
<div class="line">                                           _event_handler1_cb,</div>
<div class="line">                                           ctxt.str1);</div>
<div class="line">   ctxt.handler2 = <a class="code" href="group__Ecore__Event__Group.html#gae75b0b1b2c50e73b8e42afc628b00a62">ecore_event_handler_add</a>(_event_type,</div>
<div class="line">                                           _event_handler2_cb,</div>
<div class="line">                                           &amp;ctxt);</div>
<div class="ttc" id="agroup__Ecore__Event__Group_html_gae75b0b1b2c50e73b8e42afc628b00a62"><div class="ttname"><a href="group__Ecore__Event__Group.html#gae75b0b1b2c50e73b8e42afc628b00a62">ecore_event_handler_add</a></div><div class="ttdeci">Ecore_Event_Handler * ecore_event_handler_add(int type, Ecore_Event_Handler_Cb func, const void *data)</div><div class="ttdoc">Adds an event handler.</div><div class="ttdef"><b>Definition:</b> ecore_events.c:13</div></div>
</div><!-- fragment --><p> This is very simple. Just need to call <a class="el" href="group__Ecore__Event__Group.html#gae75b0b1b2c50e73b8e42afc628b00a62" title="Adds an event handler.">ecore_event_handler_add()</a> with the respective event type, the callback function to be called, and a data pointer that will be passed to the callback when it is called by the event.</p>
<p>Then we start firing events:</p>
<div class="fragment"><div class="line"> </div>
<div class="line">   <span class="keywordflow">for</span> (i = 0; i &lt;= 15; i++)</div>
<div class="line">     {</div>
<div class="line">        <span class="keywordtype">int</span> *event_data = malloc(<span class="keyword">sizeof</span>(*event_data));</div>
<div class="line">        *event_data = i;</div>
<div class="line">        <a class="code" href="group__Ecore__Event__Group.html#gacea6a144774958a7188274b79c91ee1f">ecore_event_add</a>(_event_type, event_data, NULL, NULL);</div>
<div class="line">     }</div>
<div class="ttc" id="agroup__Ecore__Event__Group_html_gacea6a144774958a7188274b79c91ee1f"><div class="ttname"><a href="group__Ecore__Event__Group.html#gacea6a144774958a7188274b79c91ee1f">ecore_event_add</a></div><div class="ttdeci">Ecore_Event * ecore_event_add(int type, void *ev, Ecore_End_Cb func_free, void *data)</div><div class="ttdoc">Adds an event to the event queue.</div><div class="ttdef"><b>Definition:</b> ecore_events.c:52</div></div>
</div><!-- fragment --><p> This <code>for</code> will fire 16 events of this type. Notice that the events will be fired consecutively, but any callback will be called yet. They are just called by the main loop, and since it wasn't even started, nothing happens yet. For each event fired, we allocate an integer that will hold the number of the event (we are arbitrarily creating these numbers just for demonstration purposes). It's up to the event creator to decide which type of information it wants to give to the event handler, and the event handler must know what is the event info structure for that type of event.</p>
<p>Since we are not allocating any complex structure, just a simple integer, we don't need to pass any special free function to <a class="el" href="group__Ecore__Event__Group.html#gacea6a144774958a7188274b79c91ee1f" title="Adds an event to the event queue.">ecore_event_add()</a>, and it will use a simple <code>free</code> on our data. That's the default behavior.</p>
<p>Now finishing our example:</p>
<div class="fragment"><div class="line"> </div>
<div class="line">   printf(<span class="stringliteral">&quot;start the main loop.\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">   <a class="code" href="group__Ecore__Main__Loop__Group.html#gaf103b9f668bb3e4fed12e52c6180132d">ecore_main_loop_begin</a>();</div>
<div class="line"> </div>
<div class="line">   <a class="code" href="group__Ecore__Init__Group.html#ga768298b932f18d7e7593a447493e5cde">ecore_shutdown</a>();</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__Ecore__Init__Group_html_ga768298b932f18d7e7593a447493e5cde"><div class="ttname"><a href="group__Ecore__Init__Group.html#ga768298b932f18d7e7593a447493e5cde">ecore_shutdown</a></div><div class="ttdeci">EAPI int ecore_shutdown(void)</div><div class="ttdoc">Shuts down connections, signal handlers sockets etc.</div><div class="ttdef"><b>Definition:</b> ecore.c:371</div></div>
<div class="ttc" id="agroup__Ecore__Main__Loop__Group_html_gaf103b9f668bb3e4fed12e52c6180132d"><div class="ttname"><a href="group__Ecore__Main__Loop__Group.html#gaf103b9f668bb3e4fed12e52c6180132d">ecore_main_loop_begin</a></div><div class="ttdeci">void ecore_main_loop_begin(void)</div><div class="ttdoc">Runs the application main loop.</div><div class="ttdef"><b>Definition:</b> ecore_main.c:1311</div></div>
</div><!-- fragment --><p> We just start the main loop and watch things happen, waiting to shutdown Ecore when the main loop exits and return. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="footer">
  <p>
    <span class="version">EFL 1.26.99</span>
    <span class="copyright">Copyright &copy;2000-2022 <a href="http://www.enlightenment.org">enlightenment.org</a></span>
    <span class="generated">Generated @ Sat Oct 29 2022 18:10:35</span>
  </p>
</div>
</body>
</html>
