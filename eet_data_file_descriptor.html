<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <title>Advanced use of Eet Data Descriptors</title>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-110876574-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-110876574-1');
  </script>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link rel="icon" href="favicon.png" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
  <link rel="icon" href="favicon.png" type="image/ico">
  <link rel="shortcut icon" href="favicon.png" type="image/ico">
  <link rel="stylesheet" type="text/css" href="e.css">
</head>
<body>
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Advanced use of Eet Data Descriptors </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A real life example is usually the best way to see how things are used, but they also involve a lot more code than what needs to be shown, so instead of going that way, we'll be borrowing some pieces from one in the following example.</p>
<p>It's been slightly modified from the original source to show more of the varied ways in which Eet can handle our data.</p>
<p><a class="el" href="eet-data-file_descriptor_01_8c-example.html">This example</a> shows a cache of user accounts and messages received, and it's a bit more interactive than previous examples.</p>
<p>Let's begin by looking at the structures we'll be using. First we have one to define the messages the user receives and one for the one he posts. Straight forward and nothing new here.  </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span>  *screen_name;</div>
<div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span>  *name;</div>
<div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span>  *message;</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> id;</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> status_id;</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> date;</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timeline;</div>
<div class="line">} My_Message;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *dm_to;</div>
<div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *message;</div>
<div class="line">} My_Post;</div>
</div><!-- fragment --><p> One more to declare the account itself. This one will contain a list of all messages received, and the posts we make ourselves will be kept in an array. No special reason other than to show how to use arrays with Eet. </p><div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> id;</div>
<div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span>  *name;</div>
<div class="line">   <a class="code" href="struct__Eina__List.html">Eina_List</a>   *messages;</div>
<div class="line">   My_Post     *posts;</div>
<div class="line">   <span class="keywordtype">int</span>          posts_count;</div>
<div class="line">} My_Account;</div>
<div class="ttc" id="astruct__Eina__List_html"><div class="ttname"><a href="struct__Eina__List.html">_Eina_List</a></div><div class="ttdoc">Type for a generic double linked list.</div><div class="ttdef"><b>Definition:</b> eina_list.h:318</div></div>
</div><!-- fragment --><p> Finally, the main structure to hold our cache of accounts. We'll be looking for these accounts by their names, so let's keep them in a hash, using that name as the key. </p><div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> version; <span class="comment">// it is recommended to use versioned configuration!</span></div>
<div class="line">   <a class="code" href="group__Eina__Hash__Group.html#ga9a89d7d3ee260d3a60572ebf651b07e0">Eina_Hash</a>   *accounts;</div>
<div class="line">} My_Cache;</div>
<div class="ttc" id="agroup__Eina__Hash__Group_html_ga9a89d7d3ee260d3a60572ebf651b07e0"><div class="ttname"><a href="group__Eina__Hash__Group.html#ga9a89d7d3ee260d3a60572ebf651b07e0">Eina_Hash</a></div><div class="ttdeci">struct _Eina_Hash Eina_Hash</div><div class="ttdoc">Type for a generic hash table.</div><div class="ttdef"><b>Definition:</b> eina_hash.h:285</div></div>
</div><!-- fragment --><p> As explained before, we need one descriptor for each struct we want Eet to handle, but this time we also want to keep around our Eet file and its string dictionary. You will see why in a moment. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group__Eet__Data__Group.html#ga4baec0e840012480a0958c5c3bca276d">Eet_Data_Descriptor</a> *_my_cache_descriptor;</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__Eet__Data__Group.html#ga4baec0e840012480a0958c5c3bca276d">Eet_Data_Descriptor</a> *_my_account_descriptor;</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__Eet__Data__Group.html#ga4baec0e840012480a0958c5c3bca276d">Eet_Data_Descriptor</a> *_my_message_descriptor;</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__Eet__Data__Group.html#ga4baec0e840012480a0958c5c3bca276d">Eet_Data_Descriptor</a> *_my_post_descriptor;</div>
<div class="ttc" id="agroup__Eet__Data__Group_html_ga4baec0e840012480a0958c5c3bca276d"><div class="ttname"><a href="group__Eet__Data__Group.html#ga4baec0e840012480a0958c5c3bca276d">Eet_Data_Descriptor</a></div><div class="ttdeci">struct _Eet_Data_Descriptor Eet_Data_Descriptor</div><div class="ttdoc">Opaque handle that have information on a type members.</div><div class="ttdef"><b>Definition:</b> Eet.h:2648</div></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__Eet__File__Group.html#ga8d9779184a9870c1a225f1f40c76e8a7">Eet_File</a> *_my_cache_file = NULL;</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__Eet__File__Group.html#gaf0984c8280699ca5a3c4966f5580324c">Eet_Dictionary</a> *_my_cache_dict = NULL;</div>
<div class="ttc" id="agroup__Eet__File__Group_html_ga8d9779184a9870c1a225f1f40c76e8a7"><div class="ttname"><a href="group__Eet__File__Group.html#ga8d9779184a9870c1a225f1f40c76e8a7">Eet_File</a></div><div class="ttdeci">struct _Eet_File Eet_File</div><div class="ttdoc">Opaque handle that defines an Eet file (or memory).</div><div class="ttdef"><b>Definition:</b> Eet.h:527</div></div>
<div class="ttc" id="agroup__Eet__File__Group_html_gaf0984c8280699ca5a3c4966f5580324c"><div class="ttname"><a href="group__Eet__File__Group.html#gaf0984c8280699ca5a3c4966f5580324c">Eet_Dictionary</a></div><div class="ttdeci">struct _Eet_Dictionary Eet_Dictionary</div><div class="ttdoc">Opaque handle that defines a file-backed (mmaped) dictionary of strings.</div><div class="ttdef"><b>Definition:</b> Eet.h:533</div></div>
</div><!-- fragment --><p> The differences begin now. They aren't much, but we'll be creating our descriptors differently. Things can be added to our cache, but we won't be modifying the current contents, so we can consider the data read from it to be read-only, and thus allow Eet to save time and memory by not duplicating thins unnecessary. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">_my_cache_descriptor_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">   <a class="code" href="struct__Eet__Data__Descriptor__Class.html">Eet_Data_Descriptor_Class</a> eddc;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// The FILE variant is good for caches and things that are just</span></div>
<div class="line">   <span class="comment">// appended, but needs to take care when changing strings and files must</span></div>
<div class="line">   <span class="comment">// be kept open so mmap()ed strings will be kept alive.</span></div>
<div class="line">   <a class="code" href="group__Eet__Data__Group.html#ga0bf94c07d8e69cfaac8dd2d615d7542c">EET_EINA_FILE_DATA_DESCRIPTOR_CLASS_SET</a>(&amp;eddc, My_Cache);</div>
<div class="line">   _my_cache_descriptor = <a class="code" href="group__Eet__Data__Group.html#ga2a7251edf1f60ced86c4860207331bb6">eet_data_descriptor_file_new</a>(&amp;eddc);</div>
<div class="line"> </div>
<div class="line">   <a class="code" href="group__Eet__Data__Group.html#ga0bf94c07d8e69cfaac8dd2d615d7542c">EET_EINA_FILE_DATA_DESCRIPTOR_CLASS_SET</a>(&amp;eddc, My_Account);</div>
<div class="line">   _my_account_descriptor = <a class="code" href="group__Eet__Data__Group.html#ga2a7251edf1f60ced86c4860207331bb6">eet_data_descriptor_file_new</a>(&amp;eddc);</div>
<div class="line"> </div>
<div class="line">   <a class="code" href="group__Eet__Data__Group.html#ga0bf94c07d8e69cfaac8dd2d615d7542c">EET_EINA_FILE_DATA_DESCRIPTOR_CLASS_SET</a>(&amp;eddc, My_Message);</div>
<div class="line">   _my_message_descriptor = <a class="code" href="group__Eet__Data__Group.html#ga2a7251edf1f60ced86c4860207331bb6">eet_data_descriptor_file_new</a>(&amp;eddc);</div>
<div class="line"> </div>
<div class="line">   <a class="code" href="group__Eet__Data__Group.html#ga0bf94c07d8e69cfaac8dd2d615d7542c">EET_EINA_FILE_DATA_DESCRIPTOR_CLASS_SET</a>(&amp;eddc, My_Post);</div>
<div class="line">   _my_post_descriptor = <a class="code" href="group__Eet__Data__Group.html#ga2a7251edf1f60ced86c4860207331bb6">eet_data_descriptor_file_new</a>(&amp;eddc);</div>
<div class="ttc" id="agroup__Eet__Data__Group_html_ga0bf94c07d8e69cfaac8dd2d615d7542c"><div class="ttname"><a href="group__Eet__Data__Group.html#ga0bf94c07d8e69cfaac8dd2d615d7542c">EET_EINA_FILE_DATA_DESCRIPTOR_CLASS_SET</a></div><div class="ttdeci">#define EET_EINA_FILE_DATA_DESCRIPTOR_CLASS_SET(clas, type)</div><div class="ttdoc">This macro is an helper that set all the parameter of an Eet_Data_Descriptor_Class correctly when you...</div><div class="ttdef"><b>Definition:</b> Eet.h:3092</div></div>
<div class="ttc" id="agroup__Eet__Data__Group_html_ga2a7251edf1f60ced86c4860207331bb6"><div class="ttname"><a href="group__Eet__Data__Group.html#ga2a7251edf1f60ced86c4860207331bb6">eet_data_descriptor_file_new</a></div><div class="ttdeci">EAPI Eet_Data_Descriptor * eet_data_descriptor_file_new(const Eet_Data_Descriptor_Class *eddc)</div><div class="ttdoc">This function creates a new data descriptor and returns a handle to the new data descriptor.</div><div class="ttdef"><b>Definition:</b> eet_data.c:2090</div></div>
<div class="ttc" id="astruct__Eet__Data__Descriptor__Class_html"><div class="ttname"><a href="struct__Eet__Data__Descriptor__Class.html">_Eet_Data_Descriptor_Class</a></div><div class="ttdoc">Instructs Eet about memory management for different needs under serialization and parse process.</div><div class="ttdef"><b>Definition:</b> Eet.h:2845</div></div>
</div><!-- fragment --><p> As the comment in the code explains, we are asking Eet to give us strings directly from the mapped file, which avoids having to load it in memory and data duplication. Of course, there are things to take into account when doing things this way, and they will be mentioned as we encounter those special cases.</p>
<p>Next comes the actual description of our data, just like we did in the previous examples. </p><div class="fragment"><div class="line"><span class="preprocessor">#define ADD_BASIC(member, eet_type) \</span></div>
<div class="line"><span class="preprocessor">  EET_DATA_DESCRIPTOR_ADD_BASIC     \</span></div>
<div class="line"><span class="preprocessor">    (_my_message_descriptor, My_Message, # member, member, eet_type)</span></div>
<div class="line">   ADD_BASIC(screen_name, <a class="code" href="group__Eet__Data__Group.html#ga0d2cf409bf3f151156d74d18ac59e3d1">EET_T_STRING</a>);</div>
<div class="line">   ADD_BASIC(name, <a class="code" href="group__Eet__Data__Group.html#ga0d2cf409bf3f151156d74d18ac59e3d1">EET_T_STRING</a>);</div>
<div class="line">   ADD_BASIC(message, <a class="code" href="group__Eet__Data__Group.html#ga0d2cf409bf3f151156d74d18ac59e3d1">EET_T_STRING</a>);</div>
<div class="line">   ADD_BASIC(<span class="keywordtype">id</span>, <a class="code" href="group__Eet__Data__Group.html#gacf6a3c9f06e10e20be5b02cd8c6a220b">EET_T_UINT</a>);</div>
<div class="line">   ADD_BASIC(status_id, <a class="code" href="group__Eet__Data__Group.html#gacf6a3c9f06e10e20be5b02cd8c6a220b">EET_T_UINT</a>);</div>
<div class="line">   ADD_BASIC(date, <a class="code" href="group__Eet__Data__Group.html#gacf6a3c9f06e10e20be5b02cd8c6a220b">EET_T_UINT</a>);</div>
<div class="line">   ADD_BASIC(timeline, <a class="code" href="group__Eet__Data__Group.html#gacf6a3c9f06e10e20be5b02cd8c6a220b">EET_T_UINT</a>);</div>
<div class="line"><span class="preprocessor">#undef ADD_BASIC</span></div>
<div class="ttc" id="agroup__Eet__Data__Group_html_ga0d2cf409bf3f151156d74d18ac59e3d1"><div class="ttname"><a href="group__Eet__Data__Group.html#ga0d2cf409bf3f151156d74d18ac59e3d1">EET_T_STRING</a></div><div class="ttdeci">#define EET_T_STRING</div><div class="ttdoc">Data type: char *.</div><div class="ttdef"><b>Definition:</b> Eet.h:2606</div></div>
<div class="ttc" id="agroup__Eet__Data__Group_html_gacf6a3c9f06e10e20be5b02cd8c6a220b"><div class="ttname"><a href="group__Eet__Data__Group.html#gacf6a3c9f06e10e20be5b02cd8c6a220b">EET_T_UINT</a></div><div class="ttdeci">#define EET_T_UINT</div><div class="ttdoc">Data type: unsigned int.</div><div class="ttdef"><b>Definition:</b> Eet.h:2604</div></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ADD_BASIC(member, eet_type) \</span></div>
<div class="line">  <a class="code" href="group__Eet__Data__Group.html#gac38ce778d7eba37cfca8a19efb7a9b3a">EET_DATA_DESCRIPTOR_ADD_BASIC</a>     \</div>
<div class="line">    (_my_post_descriptor, My_Post, # member, member, eet_type)</div>
<div class="line">   ADD_BASIC(dm_to, <a class="code" href="group__Eet__Data__Group.html#ga0d2cf409bf3f151156d74d18ac59e3d1">EET_T_STRING</a>);</div>
<div class="line">   ADD_BASIC(message, <a class="code" href="group__Eet__Data__Group.html#ga0d2cf409bf3f151156d74d18ac59e3d1">EET_T_STRING</a>);</div>
<div class="line"><span class="preprocessor">#undef ADD_BASIC</span></div>
<div class="ttc" id="agroup__Eet__Data__Group_html_gac38ce778d7eba37cfca8a19efb7a9b3a"><div class="ttname"><a href="group__Eet__Data__Group.html#gac38ce778d7eba37cfca8a19efb7a9b3a">EET_DATA_DESCRIPTOR_ADD_BASIC</a></div><div class="ttdeci">#define EET_DATA_DESCRIPTOR_ADD_BASIC(edd, struct_type, name, member, type)</div><div class="ttdoc">Adds a basic data element to a data descriptor.</div><div class="ttdef"><b>Definition:</b> Eet.h:3449</div></div>
</div><!-- fragment --><p> And the account struct's description doesn't add much new, but it's worth commenting on it. </p><div class="fragment"><div class="line"><span class="preprocessor">#define ADD_BASIC(member, eet_type) \</span></div>
<div class="line"><span class="preprocessor">  EET_DATA_DESCRIPTOR_ADD_BASIC     \</span></div>
<div class="line"><span class="preprocessor">    (_my_account_descriptor, My_Account, # member, member, eet_type)</span></div>
<div class="line">   ADD_BASIC(name, <a class="code" href="group__Eet__Data__Group.html#ga0d2cf409bf3f151156d74d18ac59e3d1">EET_T_STRING</a>);</div>
<div class="line">   ADD_BASIC(<span class="keywordtype">id</span>, <a class="code" href="group__Eet__Data__Group.html#gacf6a3c9f06e10e20be5b02cd8c6a220b">EET_T_UINT</a>);</div>
<div class="line"><span class="preprocessor">#undef ADD_BASIC</span></div>
<div class="line"> </div>
<div class="line">   <a class="code" href="group__Eet__Data__Group.html#gabb4c7833ba053f2322e6b667a9ec7f04">EET_DATA_DESCRIPTOR_ADD_LIST</a></div>
<div class="line">     (_my_account_descriptor, My_Account, <span class="stringliteral">&quot;messages&quot;</span>, messages,</div>
<div class="line">     _my_message_descriptor);</div>
<div class="line">   <a class="code" href="group__Eet__Data__Group.html#ga7adad32d2eba76566533353632f00ae4">EET_DATA_DESCRIPTOR_ADD_VAR_ARRAY</a></div>
<div class="line">     (_my_account_descriptor, My_Account, <span class="stringliteral">&quot;posts&quot;</span>, posts,</div>
<div class="line">     _my_post_descriptor);</div>
<div class="ttc" id="agroup__Eet__Data__Group_html_ga7adad32d2eba76566533353632f00ae4"><div class="ttname"><a href="group__Eet__Data__Group.html#ga7adad32d2eba76566533353632f00ae4">EET_DATA_DESCRIPTOR_ADD_VAR_ARRAY</a></div><div class="ttdeci">#define EET_DATA_DESCRIPTOR_ADD_VAR_ARRAY(edd, struct_type, name, member, subtype)</div><div class="ttdoc">Adds a variable size array type to a data descriptor.</div><div class="ttdef"><b>Definition:</b> Eet.h:3769</div></div>
<div class="ttc" id="agroup__Eet__Data__Group_html_gabb4c7833ba053f2322e6b667a9ec7f04"><div class="ttname"><a href="group__Eet__Data__Group.html#gabb4c7833ba053f2322e6b667a9ec7f04">EET_DATA_DESCRIPTOR_ADD_LIST</a></div><div class="ttdeci">#define EET_DATA_DESCRIPTOR_ADD_LIST(edd, struct_type, name, member, subtype)</div><div class="ttdoc">Adds a linked list type to a data descriptor.</div><div class="ttdef"><b>Definition:</b> Eet.h:3528</div></div>
</div><!-- fragment --><p> How to add a list we've seen before, but now we are also adding an array. There's nothing really special about it, but it's important to note that the EET_DATA_DESCRIPTOR_ADD_VAR_ARRAY is used to add arrays of variable length to a descriptor. That is, arrays just like the one we defined. Since there's no way in C to know how long they are, we need to keep track of the count ourselves and Eet needs to know how to do so as well. That's what the <code>posts_count</code> member of our struct is for. When adding our array member, this macro will look for another variable in the struct named just like the array, but with <code>_count</code> attached to the end. When saving our data, Eet will know how many elements the array contains by looking into this count variable. When loading back from a file, this variable will be set to the right number of elements.</p>
<p>Another option for arrays is to use EET_DATA_DESCRIPTOR_ADD_ARRAY, which takes care of fixed sized arrays. For example, let's suppose that we want to keep track of only the last ten posts the user sent, and we declare our account struct as follows </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> id;</div>
<div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span>  *name;</div>
<div class="line">   <a class="code" href="struct__Eina__List.html">Eina_List</a>   *messages;</div>
<div class="line">   My_Post      posts[10];</div>
<div class="line">} My_Account;</div>
</div><!-- fragment --><p> Then we would add the array to our descriptor with </p><div class="fragment"><div class="line"><a class="code" href="group__Eet__Data__Group.html#gabc903baa4d5dc50a98f5e1a68d66fd2b">EET_DATA_DESCRIPTOR_ADD_ARRAY</a>(_my_account_descriptor, My_Account, <span class="stringliteral">&quot;posts&quot;</span>,</div>
<div class="line">                              posts, _my_post_descriptor);</div>
<div class="ttc" id="agroup__Eet__Data__Group_html_gabc903baa4d5dc50a98f5e1a68d66fd2b"><div class="ttname"><a href="group__Eet__Data__Group.html#gabc903baa4d5dc50a98f5e1a68d66fd2b">EET_DATA_DESCRIPTOR_ADD_ARRAY</a></div><div class="ttdeci">#define EET_DATA_DESCRIPTOR_ADD_ARRAY(edd, struct_type, name, member, subtype)</div><div class="ttdoc">Adds a fixed size array type to a data descriptor.</div><div class="ttdef"><b>Definition:</b> Eet.h:3737</div></div>
</div><!-- fragment --><p>Notice how this time we don't have a <code>posts_count</code> variable in our struct. We could have it for the program to keep track of how many posts the array actually contains, but Eet no longer needs it. Being defined that way the array is already taking up all the memory needed for the ten elements, and it is possible in C to determine how much it is in code. When saving our data, Eet will just dump the entire memory blob into the file, regardless of how much of it is really used. So it's important to take into consideration this kind of things when defining your data types. Each has its uses, its advantages and disadvantages and it's up to you to decide which to use.</p>
<p>Now, going back to our example, we have to finish adding our data to the descriptors. We are only missing the main one for the cache, which contains our hash of accounts. Unless you are using your own hash functions when setting the descriptor class, always use hashes with string type keys. </p><div class="fragment"><div class="line"><span class="preprocessor">#define ADD_BASIC(member, eet_type) \</span></div>
<div class="line"><span class="preprocessor">  EET_DATA_DESCRIPTOR_ADD_BASIC     \</span></div>
<div class="line"><span class="preprocessor">    (_my_cache_descriptor, My_Cache, # member, member, eet_type)</span></div>
<div class="line">   ADD_BASIC(version, <a class="code" href="group__Eet__Data__Group.html#gacf6a3c9f06e10e20be5b02cd8c6a220b">EET_T_UINT</a>);</div>
<div class="line"><span class="preprocessor">#undef ADD_BASIC</span></div>
<div class="line"> </div>
<div class="line">   <a class="code" href="group__Eet__Data__Group.html#gad5e348ead4ba0b441c1e020f9bf23365">EET_DATA_DESCRIPTOR_ADD_HASH</a></div>
<div class="line">     (_my_cache_descriptor, My_Cache, <span class="stringliteral">&quot;accounts&quot;</span>, accounts,</div>
<div class="line">     _my_account_descriptor);</div>
<div class="line">} <span class="comment">/* _my_cache_descriptor_init */</span></div>
<div class="ttc" id="agroup__Eet__Data__Group_html_gad5e348ead4ba0b441c1e020f9bf23365"><div class="ttname"><a href="group__Eet__Data__Group.html#gad5e348ead4ba0b441c1e020f9bf23365">EET_DATA_DESCRIPTOR_ADD_HASH</a></div><div class="ttdeci">#define EET_DATA_DESCRIPTOR_ADD_HASH(edd, struct_type, name, member, subtype)</div><div class="ttdoc">Adds a hash type to a data descriptor.</div><div class="ttdef"><b>Definition:</b> Eet.h:3601</div></div>
</div><!-- fragment --><p> If you remember, we told Eet not to duplicate memory when possible at the time of loading back our data. But this doesn't mean everything will be loaded straight from disk and we don't have to worry about freeing it. Data in the Eet file is compressed and encoded, so it still needs to be decoded and memory will be allocated to convert it back into something we can use. We also need to take care of anything we add in the current instance of the program. To summarize, any string we get from Eet is likely to be a pointer to the internal dictionary, and trying to free it will, in the best case, crash our application right away.</p>
<p>So how do we know if we have to free a string? We check if it's part of the dictionary, and if it's not there we can be sure it's safe to get rid of it. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">_eet_string_free(<span class="keyword">const</span> <span class="keywordtype">char</span> *str)</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">if</span> (!str)</div>
<div class="line">     <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">if</span> ((_my_cache_dict) &amp;&amp; (<a class="code" href="group__Eet__File__Group.html#ga53290da52edb929b85e51f25e79d27c8">eet_dictionary_string_check</a>(_my_cache_dict, str)))</div>
<div class="line">     <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">   <a class="code" href="group__Eina__Stringshare__Group.html#ga5538b4a134987b8a01744fad1a845ba4">eina_stringshare_del</a>(str);</div>
<div class="line">} <span class="comment">/* _eet_string_free */</span></div>
<div class="ttc" id="agroup__Eet__File__Group_html_ga53290da52edb929b85e51f25e79d27c8"><div class="ttname"><a href="group__Eet__File__Group.html#ga53290da52edb929b85e51f25e79d27c8">eet_dictionary_string_check</a></div><div class="ttdeci">EAPI int eet_dictionary_string_check(Eet_Dictionary *ed, const char *string)</div><div class="ttdoc">Checks if a given string comes from a given dictionary.</div><div class="ttdef"><b>Definition:</b> eet_dictionary.c:598</div></div>
<div class="ttc" id="agroup__Eina__Stringshare__Group_html_ga5538b4a134987b8a01744fad1a845ba4"><div class="ttname"><a href="group__Eina__Stringshare__Group.html#ga5538b4a134987b8a01744fad1a845ba4">eina_stringshare_del</a></div><div class="ttdeci">EINA_API void eina_stringshare_del(Eina_Stringshare *str)</div><div class="ttdoc">Notes that the given string has lost an instance.</div><div class="ttdef"><b>Definition:</b> eina_stringshare.c:533</div></div>
</div><!-- fragment --><p> See how this is used when adding a new message to our cache. </p><div class="fragment"><div class="line"><span class="keyword">static</span> My_Message *</div>
<div class="line">_my_message_new(<span class="keyword">const</span> <span class="keywordtype">char</span> *message)</div>
<div class="line">{</div>
<div class="line">   My_Message *msg = calloc(1, <span class="keyword">sizeof</span>(My_Message));</div>
<div class="line">   <span class="keywordflow">if</span> (!msg)</div>
<div class="line">     {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;ERROR: could not calloc My_Message\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">   msg-&gt;message = <a class="code" href="group__Eina__Stringshare__Group.html#ga21333851ab331b4d19d81bbef4996385">eina_stringshare_add</a>(message);</div>
<div class="line">   <span class="keywordflow">return</span> msg;</div>
<div class="ttc" id="agroup__Eina__Stringshare__Group_html_ga21333851ab331b4d19d81bbef4996385"><div class="ttname"><a href="group__Eina__Stringshare__Group.html#ga21333851ab331b4d19d81bbef4996385">eina_stringshare_add</a></div><div class="ttdeci">EINA_API Eina_Stringshare * eina_stringshare_add(const char *str)</div><div class="ttdoc">Retrieves an instance of a string for use in a program.</div><div class="ttdef"><b>Definition:</b> eina_stringshare.c:606</div></div>
<div class="line">} <span class="comment">/* _my_message_new */</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">_my_message_free(My_Message *msg)</div>
<div class="line">{</div>
<div class="line">   _eet_string_free(msg-&gt;screen_name);</div>
<div class="line">   _eet_string_free(msg-&gt;name);</div>
<div class="line">   _eet_string_free(msg-&gt;message);</div>
<div class="line">   free(msg);</div>
<div class="line">} <span class="comment">/* _my_message_free */</span></div>
</div><!-- fragment --><p> Skipping all the utility functions used by our program (remember you can look at the full example <a class="el" href="eet-data-file_descriptor_01_8c-example.html">here</a>) we get to our cache loading code. Nothing out of the ordinary at first, just the same old open file, read data using our main descriptor to decode it into something we can use and check version of loaded data and if it doesn't match, do something accordingly. </p><div class="fragment"><div class="line"><span class="keyword">static</span> My_Cache *</div>
<div class="line">_my_cache_new(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">   My_Cache *my_cache = calloc(1, <span class="keyword">sizeof</span>(My_Cache));</div>
<div class="line">   <span class="keywordflow">if</span> (!my_cache)</div>
<div class="line">     {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;ERROR: could not calloc My_Cache\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">   my_cache-&gt;accounts = <a class="code" href="group__Eina__Hash__Group.html#ga298b6e788d5593a8984eed85fbbc240a">eina_hash_string_small_new</a>(NULL);</div>
<div class="line"> </div>
<div class="line">   my_cache-&gt;version = 1;</div>
<div class="line">   <span class="keywordflow">return</span> my_cache;</div>
<div class="line">} <span class="comment">/* _my_cache_new */</span></div>
<div class="ttc" id="agroup__Eina__Hash__Group_html_ga298b6e788d5593a8984eed85fbbc240a"><div class="ttname"><a href="group__Eina__Hash__Group.html#ga298b6e788d5593a8984eed85fbbc240a">eina_hash_string_small_new</a></div><div class="ttdeci">EINA_API Eina_Hash * eina_hash_string_small_new(Eina_Free_Cb data_free_cb)</div><div class="ttdoc">Creates a new hash table for use with strings with small bucket size.</div><div class="ttdef"><b>Definition:</b> eina_hash.c:800</div></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__Eina__Types__Group.html#ga3fe0caf72e93b1bab1ca8ee3ccf3f226">Eina_Bool</a></div>
<div class="line">_my_cache_account_free_cb(<span class="keyword">const</span> <a class="code" href="group__Eina__Hash__Group.html#ga9a89d7d3ee260d3a60572ebf651b07e0">Eina_Hash</a> *hash <a class="code" href="group__Eina__Types__Group.html#ga82d751be730f849719ca292f9558be87">EINA_UNUSED</a>,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">void</span>      *key <a class="code" href="group__Eina__Types__Group.html#ga82d751be730f849719ca292f9558be87">EINA_UNUSED</a>,</div>
<div class="line">                          <span class="keywordtype">void</span>            *data,</div>
<div class="line">                          <span class="keywordtype">void</span>            *fdata <a class="code" href="group__Eina__Types__Group.html#ga82d751be730f849719ca292f9558be87">EINA_UNUSED</a>)</div>
<div class="line">{</div>
<div class="line">   _my_account_free(data);</div>
<div class="line">   <span class="keywordflow">return</span> <a class="code" href="group__Eina__Types__Group.html#ga05c12dacc8b4058994df842b41be85fc">EINA_TRUE</a>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__Eina__Types__Group_html_ga05c12dacc8b4058994df842b41be85fc"><div class="ttname"><a href="group__Eina__Types__Group.html#ga05c12dacc8b4058994df842b41be85fc">EINA_TRUE</a></div><div class="ttdeci">#define EINA_TRUE</div><div class="ttdoc">boolean value TRUE (numerical value 1)</div><div class="ttdef"><b>Definition:</b> eina_types.h:539</div></div>
<div class="ttc" id="agroup__Eina__Types__Group_html_ga3fe0caf72e93b1bab1ca8ee3ccf3f226"><div class="ttname"><a href="group__Eina__Types__Group.html#ga3fe0caf72e93b1bab1ca8ee3ccf3f226">Eina_Bool</a></div><div class="ttdeci">unsigned char Eina_Bool</div><div class="ttdoc">Type to mimic a boolean.</div><div class="ttdef"><b>Definition:</b> eina_types.h:527</div></div>
<div class="ttc" id="agroup__Eina__Types__Group_html_ga82d751be730f849719ca292f9558be87"><div class="ttname"><a href="group__Eina__Types__Group.html#ga82d751be730f849719ca292f9558be87">EINA_UNUSED</a></div><div class="ttdeci">#define EINA_UNUSED</div><div class="ttdoc">Used to indicate that a function parameter is purposely unused.</div><div class="ttdef"><b>Definition:</b> eina_types.h:339</div></div>
</div><!-- fragment --><p> Then comes the interesting part. Remember how we kept two more global variables with our descriptors? One of them we already used to check if it was right to free a string or not, but we didn't know where it came from. Loading our data straight from the mmapped file means that we can't close it until we are done using it, so we need to keep its handler around until then. It also means that any changes done to the file can, and will, invalidate all our pointers to the file backed data, so if we add something and save the file, we need to reload our cache.</p>
<p>Thus our load function checks if we had an open file, if there is it gets closed and our variable is updated to the new handler. Then we get the string dictionary we use to check if a string is part of it or not. Updating any references to the cache data is up you as a programmer to handle properly, there's nothing Eet can do in this situation. </p><div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">_my_cache_free(My_Cache *my_cache)</div>
<div class="line">{</div>
<div class="line">   <a class="code" href="group__Eina__Hash__Group.html#ga9237dbade8e59ac827992c7a5146cb20">eina_hash_foreach</a>(my_cache-&gt;accounts, _my_cache_account_free_cb, NULL);</div>
<div class="line">   <a class="code" href="group__Eina__Hash__Group.html#ga76829f09c99852b1536efc813d99fc78">eina_hash_free</a>(my_cache-&gt;accounts);</div>
<div class="line">   free(my_cache);</div>
<div class="line">} <span class="comment">/* _my_cache_free */</span></div>
<div class="ttc" id="agroup__Eina__Hash__Group_html_ga76829f09c99852b1536efc813d99fc78"><div class="ttname"><a href="group__Eina__Hash__Group.html#ga76829f09c99852b1536efc813d99fc78">eina_hash_free</a></div><div class="ttdeci">EINA_API void eina_hash_free(Eina_Hash *hash)</div><div class="ttdoc">Frees the given hash table's resources.</div><div class="ttdef"><b>Definition:</b> eina_hash.c:868</div></div>
<div class="ttc" id="agroup__Eina__Hash__Group_html_ga9237dbade8e59ac827992c7a5146cb20"><div class="ttname"><a href="group__Eina__Hash__Group.html#ga9237dbade8e59ac827992c7a5146cb20">eina_hash_foreach</a></div><div class="ttdeci">EINA_API void eina_hash_foreach(const Eina_Hash *hash, Eina_Hash_Foreach func, const void *fdata)</div><div class="ttdoc">Calls a function on every member stored in the hash table.</div><div class="ttdef"><b>Definition:</b> eina_hash.c:1223</div></div>
</div><!-- fragment --><p> The save function doesn't have anything new, and all that's left after it is the main program, which doesn't really have anything of interest within the scope of what we are learning. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="footer">
  <p>
    <span class="version">EFL 1.26.99</span>
    <span class="copyright">Copyright &copy;2000-2022 <a href="http://www.enlightenment.org">enlightenment.org</a></span>
    <span class="generated">Generated @ Sat Oct 29 2022 18:10:31</span>
  </p>
</div>
</body>
</html>
